<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Funding Matches - Preview</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #1a202c;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .info-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .info-item label {
            display: block;
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-item .value {
            font-size: 16px;
            color: #1a202c;
            font-weight: 600;
        }

        .timer {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            margin-top: 20px;
        }

        .content-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .loading-state,
        .error-state,
        .no-matches-state,
        .matches-state {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }

        .loading-state.active,
        .error-state.active,
        .no-matches-state.active,
        .matches-state.active {
            display: block;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-state p {
            color: #718096;
            font-size: 16px;
            margin: 10px 0;
        }

        .error-state .icon,
        .no-matches-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-state h2,
        .no-matches-state h2 {
            color: #1a202c;
            font-size: 24px;
            margin-bottom: 15px;
        }

        .error-state p,
        .no-matches-state p {
            color: #718096;
            font-size: 16px;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto 25px;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .matches-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .matches-header .icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .matches-header h2 {
            color: #1a202c;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .matches-header p {
            color: #718096;
            font-size: 16px;
        }

        .total-matches {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 30px 0;
        }

        .total-matches .number {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .match-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .match-category {
            background: #f7fafc;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.3s;
        }

        .match-category:hover {
            transform: translateY(-5px);
        }

        .match-category .icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .match-category h3 {
            color: #1a202c;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .match-category .subtitle {
            color: #718096;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .match-category .count {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .sample-lenders {
            margin-top: 50px;
        }

        .sample-lenders h3 {
            color: #1a202c;
            font-size: 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sample-lenders p {
            color: #718096;
            margin-bottom: 25px;
        }

        .pricing-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 16px;
            margin-top: 30px;
            text-align: center;
        }

        .pricing-card h3 {
            font-size: 24px;
            margin-bottom: 20px;
        }

        .price {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }

        .price small {
            font-size: 24px;
            opacity: 0.9;
        }

        .features {
            text-align: left;
            max-width: 400px;
            margin: 30px auto;
        }

        .feature {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 12px 0;
            font-size: 16px;
        }

        .btn-payment {
            background: white;
            color: #667eea;
            font-size: 18px;
            padding: 15px 40px;
            margin-top: 20px;
        }

        .btn-payment:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.3);
        }

        .security-note {
            margin-top: 20px;
            font-size: 14px;
            opacity: 0.9;
        }

        .back-link {
            display: inline-block;
            margin-top: 30px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Your Funding Matches</h1>
            <p>Preview your potential lending partners</p>
            
            <div class="info-grid">
                <div class="info-item">
                    <label>Application ID:</label>
                    <div class="value" id="applicationId">Loading...</div>
                </div>
                <div class="info-item">
                    <label>Applicant:</label>
                    <div class="value" id="applicantName">Loading...</div>
                </div>
                <div class="info-item">
                    <label>Email:</label>
                    <div class="value" id="applicantEmail">Loading...</div>
                </div>
            </div>

            <div class="timer">
                <span>üïê</span>
                <span>Preview expires in: <strong id="countdown">23:59:59</strong></span>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="content-card">
            <!-- Loading State -->
            <div class="loading-state active" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Analyzing your requirements...</p>
                <p>Searching our network of verified lenders</p>
            </div>

            <!-- Error State -->
            <div class="error-state" id="errorState">
                <div class="icon">‚ö†Ô∏è</div>
                <h2>Error Loading Matches</h2>
                <p id="errorMessage">We encountered an issue loading your matches. Please try again.</p>
                <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
            </div>

            <!-- No Matches State -->
            <div class="no-matches-state" id="noMatchesState">
                <div class="icon">üòî</div>
                <h2>No Matches Found</h2>
                <p>Unfortunately, we couldn't find any lenders that match your current criteria. This could be due to specific requirements that fall outside typical lending parameters.</p>
                <a href="form-borrower.html" class="btn btn-primary">Modify Requirements</a>
                <a href="mailto:support@example.com" class="btn btn-secondary">Contact Support</a>
            </div>

            <!-- Matches State -->
            <div class="matches-state" id="matchesState">
                <div class="matches-header">
                    <div class="icon">üéâ</div>
                    <h2>Great news! We found matches for your funding request</h2>
                    <p>Based on your requirements, we've identified potential lenders ready to review your application.</p>
                </div>

                <div class="total-matches">
                    <p>We found</p>
                    <div class="number" id="totalMatchCount">0</div>
                    <p>lenders</p>
                </div>

                <div class="match-breakdown">
                    <div class="match-category">
                        <div class="icon">üåü</div>
                        <h3>Best Matches</h3>
                        <div class="subtitle">(85-95% match)</div>
                        <div class="count" id="bestMatchCount">0</div>
                    </div>
                    <div class="match-category">
                        <div class="icon">‚ú®</div>
                        <h3>Good Matches</h3>
                        <div class="subtitle">(70-84% match)</div>
                        <div class="count" id="goodMatchCount">0</div>
                    </div>
                    <div class="match-category">
                        <div class="icon">üíº</div>
                        <h3>Potential Matches</h3>
                        <div class="subtitle">(60-69% match)</div>
                        <div class="count" id="potentialMatchCount">0</div>
                    </div>
                </div>

                <div class="sample-lenders">
                    <h3><span>üîí</span> Sample Matched Lenders</h3>
                    <p>Below are anonymized examples of lenders that match your criteria. Full details including names and contact information will be available after payment.</p>
                </div>

                <div class="pricing-card">
                    <h3>Unlock Full Access</h3>
                    <div class="price">
                        <small>CHF</small> <span id="priceAmount">2000</span>
                    </div>
                    
                    <div class="features">
                        <div class="feature">‚úì Complete lender profiles and names</div>
                        <div class="feature">‚úì Direct contact information</div>
                        <div class="feature">‚úì Specific loan terms and rates</div>
                        <div class="feature">‚úì Application requirements</div>
                        <div class="feature">‚úì Priority processing (48-72 hours)</div>
                        <div class="feature">‚úì Direct communication with matched lenders</div>
                    </div>

                    <button class="btn btn-payment" id="paymentBtn">Proceed to Secure Payment</button>
                    
                    <p class="security-note">üîí Secure Payment: Your payment is processed securely through Stripe. We never store your payment information.</p>
                </div>
            </div>

            <a href="index.html" class="back-link">‚Üê Go Back</a>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const submissionId = urlParams.get('submission_id');
        const email = urlParams.get('email');
        const fullName = urlParams.get('full_name');

        // Countdown timer (24 hours)
        let timeLeft = 24 * 60 * 60; // 24 hours in seconds

        function updateCountdown() {
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            
            document.getElementById('countdown').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            if (timeLeft > 0) {
                timeLeft--;
            }
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();

        // Show different states
        function showLoading() {
            document.getElementById('loadingState').classList.add('active');
            document.getElementById('errorState').classList.remove('active');
            document.getElementById('noMatchesState').classList.remove('active');
            document.getElementById('matchesState').classList.remove('active');
        }

        function showError(message = 'We encountered an issue loading your matches. Please try again.') {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('errorState').classList.add('active');
            document.getElementById('noMatchesState').classList.remove('active');
            document.getElementById('matchesState').classList.remove('active');
            document.getElementById('errorMessage').textContent = message;
        }

        function showNoMatches() {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('errorState').classList.remove('active');
            document.getElementById('noMatchesState').classList.add('active');
            document.getElementById('matchesState').classList.remove('active');
        }

        function showMatches() {
            document.getElementById('loadingState').classList.remove('active');
            document.getElementById('errorState').classList.remove('active');
            document.getElementById('noMatchesState').classList.remove('active');
            document.getElementById('matchesState').classList.add('active');
        }

        // Fetch match data from n8n webhook
        async function fetchMatchData() {
            if (!submissionId || !email) {
                console.error('Missing required parameters');
                showError('Missing required parameters. Please use the link from your email.');
                return;
            }

            // Update header info immediately
            document.getElementById('applicationId').textContent = submissionId;
            document.getElementById('applicantName').textContent = decodeURIComponent(fullName || 'N/A');
            document.getElementById('applicantEmail').textContent = email;

            try {
                showLoading();
                
                const url = `https://contentlabs.app.n8n.cloud/webhook/generate-preview?submission_id=${submissionId}&email=${email}&full_name=${encodeURIComponent(fullName || '')}`;
                
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                let data = await response.json();
                
                // ‚úÖ FIX: Handle array response from n8n
                if (Array.isArray(data) && data.length > 0) {
                    console.log('Converting array response to object');
                    data = data[0];
                }
                
                console.log('Received data:', data);
                
                if (data.error) {
                    showError(data.message || 'An error occurred');
                    return;
                }

                if (!data.total_matches || data.total_matches === 0) {
                    showNoMatches();
                    return;
                }

                // Display the matches
                displayMatches(data);
                
            } catch (error) {
                console.error('Error fetching match data:', error);
                showError('Unable to load your matches. Please try again later or contact support.');
            }
        }

        function displayMatches(data) {
            // Update counts
            document.getElementById('totalMatchCount').textContent = data.total_matches || 0;
            document.getElementById('bestMatchCount').textContent = data.breakdown?.best_matches || 0;
            document.getElementById('goodMatchCount').textContent = data.breakdown?.good_matches || 0;
            document.getElementById('potentialMatchCount').textContent = data.breakdown?.potential_matches || 0;
            
            // Update price
            document.getElementById('priceAmount').textContent = data.price || 2000;
            
            // Show matches state
            showMatches();

            // Setup payment button
            document.getElementById('paymentBtn').onclick = function() {
                // Store submission data for payment page
                localStorage.setItem('pendingPayment', JSON.stringify({
                    submission_id: submissionId,
                    email: email,
                    full_name: fullName,
                    total_matches: data.total_matches,
                    price: data.price
                }));
                
                // Redirect to payment page
                window.location.href = 'payment.html';
            };
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', fetchMatchData);
    </script>
</body>
</html>