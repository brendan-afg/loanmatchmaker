<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Funding Matches - Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .match-card {
            transition: all 0.3s ease;
        }
        .match-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Your Funding Matches</h1>
            <p class="text-gray-600">Preview your potential lending partners</p>
            
            <!-- Application Info -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">APPLICATION ID:</p>
                    <p id="app-id" class="font-semibold text-gray-800">Loading...</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">APPLICANT:</p>
                    <p id="applicant-name" class="font-semibold text-gray-800">Loading...</p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600 mb-1">EMAIL:</p>
                    <p id="applicant-email" class="font-semibold text-gray-800">Loading...</p>
                </div>
            </div>

            <!-- Timer -->
            <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">üïê</span>
                    <div>
                        <p class="text-sm text-gray-600">Preview expires in:</p>
                        <p id="timer" class="text-xl font-bold text-gray-800">23:59:59</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="bg-white rounded-lg shadow-lg p-8">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-4"></div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Analyzing your requirements...</h3>
                <p class="text-gray-600">Searching our network of verified lenders</p>
            </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="bg-white rounded-lg shadow-lg p-8 hidden">
            <div class="text-center">
                <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Error Loading Matches</h3>
                <button onclick="loadMatches()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                    Try Again
                </button>
            </div>
        </div>

        <!-- No Matches State -->
        <div id="no-matches-state" class="bg-white rounded-lg shadow-lg p-8 hidden">
            <div class="text-center">
                <div class="text-6xl mb-4">üòî</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Matches Found</h3>
                <p class="text-gray-600 mb-6">Unfortunately, we couldn't find any lenders that match your current criteria.</p>
                <p class="text-gray-500 text-sm mb-6">This could be due to specific requirements that fall outside typical lending parameters.</p>
                <div class="flex gap-4 justify-center">
                    <button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                        Modify Requirements
                    </button>
                    <button class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                        Contact Support
                    </button>
                </div>
            </div>
        </div>

        <!-- Matches Found State -->
        <div id="matches-state" class="hidden">
            <!-- Success Message -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <div class="flex items-start">
                    <div class="text-4xl mr-4">üéâ</div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Great news! We found matches for your funding request</h2>
                        <p class="text-gray-600">Based on your requirements, we've identified potential lenders ready to review your application.</p>
                    </div>
                </div>
            </div>

            <!-- Match Statistics -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">We found <span id="total-matches" class="text-blue-600">0</span> lenders</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">üåü</span>
                            <h4 class="font-semibold text-gray-800">Best Matches</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">(85-95% match)</p>
                        <p id="best-matches" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">‚ú®</span>
                            <h4 class="font-semibold text-gray-800">Good Matches</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">(70-84% match)</p>
                        <p id="good-matches" class="text-3xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-2">üíº</span>
                            <h4 class="font-semibold text-gray-800">Potential Matches</h4>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">(60-69% match)</p>
                        <p id="potential-matches" class="text-3xl font-bold text-purple-600">0</p>
                    </div>
                </div>
            </div>

            <!-- Sample Lenders -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6 fade-in">
                <div class="flex items-center mb-4">
                    <span class="text-2xl mr-2">üîí</span>
                    <h3 class="text-xl font-semibold text-gray-800">Sample Matched Lenders</h3>
                </div>
                <p class="text-gray-600 mb-6">Below are anonymized examples of lenders that match your criteria. Full details including names and contact information will be available after payment.</p>
                
                <div id="lenders-container" class="space-y-4">
                    <!-- Lender cards will be inserted here -->
                </div>
            </div>

            <!-- Payment CTA -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg shadow-lg p-8 text-white fade-in">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-bold mb-2">Unlock Full Access</h3>
                    <div class="text-5xl font-bold mb-4">CHF <span>2000</span></div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6 text-sm">
                    <div class="flex items-start">
                        <span class="mr-2">‚úì</span>
                        <span>Complete lender profiles and names</span>
                    </div>
                    <div class="flex items-start">
                        <span class="mr-2">‚úì</span>
                        <span>Direct contact information</span>
                    </div>
                    <div class="flex items-start">
                        <span class="mr-2">‚úì</span>
                        <span>Specific loan terms and rates</span>
                    </div>
                    <div class="flex items-start">
                        <span class="mr-2">‚úì</span>
                        <span>Application requirements</span>
                    </div>
                    <div class="flex items-start">
                        <span class="mr-2">‚úì</span>
                        <span>Priority processing (48-72 hours)</span>
                    </div>
                    <div class="flex items-start">
                        <span class="mr-2">‚úì</span>
                        <span>Direct communication with matched lenders</span>
                    </div>
                </div>

                <div class="text-center">
                    <a id="payment-link" href="#" class="inline-block bg-white text-blue-600 px-8 py-4 rounded-lg font-semibold text-lg hover:bg-gray-100 transition shadow-lg">
                        Proceed to Secure Payment
                    </a>
                    <p class="mt-4 text-sm text-blue-100">
                        <span class="mr-2">üîí</span>
                        Secure Payment: Your payment is processed securely through Stripe. We never store your payment information.
                    </p>
                </div>
            </div>

            <!-- Go Back Button -->
            <div class="text-center mt-6">
                <button onclick="window.history.back()" class="text-gray-600 hover:text-gray-800 transition">
                    ‚Üê Go Back
                </button>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        const submissionId = getUrlParameter('submission_id');
        const email = getUrlParameter('email');
        const fullName = getUrlParameter('full_name');

        // Update payment link with parameters
        function updatePaymentLink() {
            const paymentLink = document.getElementById('payment-link');
            const baseUrl = 'https://loanmatchpro.altfundsglobal.com/payment.html';
            const params = new URLSearchParams({
                submission_id: submissionId,
                email: email,
                full_name: fullName
            });
            paymentLink.href = `${baseUrl}?${params.toString()}`;
        }

        // Update application info
        function updateApplicationInfo() {
            document.getElementById('app-id').textContent = submissionId || 'N/A';
            document.getElementById('applicant-name').textContent = fullName || 'N/A';
            document.getElementById('applicant-email').textContent = email || 'N/A';
        }

        // Timer countdown
        function startTimer() {
            let timeLeft = 24 * 60 * 60 - 1; // 23:59:59
            const timerElement = document.getElementById('timer');
            
            setInterval(() => {
                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;
                
                timerElement.textContent = 
                    String(hours).padStart(2, '0') + ':' + 
                    String(minutes).padStart(2, '0') + ':' + 
                    String(seconds).padStart(2, '0');
                
                if (timeLeft > 0) {
                    timeLeft--;
                }
            }, 1000);
        }

        // Load matches from backend
        async function loadMatches() {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const noMatchesState = document.getElementById('no-matches-state');
            const matchesState = document.getElementById('matches-state');

            // Show loading
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            noMatchesState.classList.add('hidden');
            matchesState.classList.add('hidden');

            try {
                // Call n8n webhook
                const response = await fetch(`https://brendanwenzel.app.n8n.cloud/webhook/lender-matches?submission_id=${submissionId}`);
                
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                // Hide loading
                loadingState.classList.add('hidden');

                if (!data.matches || data.matches.length === 0) {
                    noMatchesState.classList.remove('hidden');
                } else {
                    // Show matches
                    matchesState.classList.remove('hidden');
                    displayMatches(data.matches);
                }
            } catch (error) {
                console.error('Error loading matches:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            }
        }

        // Display matches
        function displayMatches(matches) {
            // Count matches by tier
            let bestCount = 0, goodCount = 0, potentialCount = 0;
            
            matches.forEach(match => {
                if (match.matchScore >= 85) bestCount++;
                else if (match.matchScore >= 70) goodCount++;
                else if (match.matchScore >= 60) potentialCount++;
            });

            document.getElementById('total-matches').textContent = matches.length;
            document.getElementById('best-matches').textContent = bestCount;
            document.getElementById('good-matches').textContent = goodCount;
            document.getElementById('potential-matches').textContent = potentialCount;

            // Display lender cards
            const container = document.getElementById('lenders-container');
            container.innerHTML = '';

            matches.forEach((match, index) => {
                const card = createLenderCard(match, index);
                container.appendChild(card);
            });
        }

        // Create lender card
        function createLenderCard(match, index) {
            const div = document.createElement('div');
            div.className = 'match-card bg-gray-50 border border-gray-200 rounded-lg p-6';
            
            let tierBadge = '';
            let tierColor = '';
            if (match.matchScore >= 85) {
                tierBadge = 'üåü Best Match';
                tierColor = 'bg-green-100 text-green-800';
            } else if (match.matchScore >= 70) {
                tierBadge = '‚ú® Good Match';
                tierColor = 'bg-blue-100 text-blue-800';
            } else {
                tierBadge = 'üíº Potential Match';
                tierColor = 'bg-purple-100 text-purple-800';
            }

            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h4 class="text-lg font-semibold text-gray-800">Lender ${index + 1}</h4>
                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${tierColor}">${tierBadge}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-600 mb-1">Match Score:</p>
                        <div class="flex items-center">
                            <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${match.matchScore}%"></div>
                            </div>
                            <span class="font-semibold text-gray-800">${match.matchScore}%</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-600 mb-1">Loan Amount Range:</p>
                        <p class="font-semibold text-gray-800">${match.loanAmountRange || 'Not specified'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 mb-1">Interest Rate Range:</p>
                        <p class="font-semibold text-gray-800">${match.interestRateRange || 'Not specified'}</p>
                    </div>
                    <div>
                        <p class="text-gray-600 mb-1">Typical Processing Time:</p>
                        <p class="font-semibold text-gray-800">${match.processingTime || 'Not specified'}</p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-300">
                    <p class="text-xs text-gray-500 italic">üîí Full lender details available after payment</p>
                </div>
            `;

            return div;
        }

        // Initialize
        updateApplicationInfo();
        updatePaymentLink();
        startTimer();
        loadMatches();
    </script>
</body>
</html>